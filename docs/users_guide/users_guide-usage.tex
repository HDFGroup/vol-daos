\section{Using the DAOS VOL connector with an HDF5 application}

This section outlines the unique aspects of writing, building and running HDF5 applications with the DAOS VOL connector. Note that this guide assumes the DAOS VOL connector has already been built; for instructions on building the DAOS VOL connector, refer to the \href{https://bitbucket.hdfgroup.org/projects/HDF5VOL/repos/daos-vol/browse/README.md}{README}.

\subsection{Writing HDF5 DAOS VOL connector applications}

\subsubsection{With the DAOS VOL connector as a dynamically-loaded plugin}

If the DAOS VOL connector is dynamically loaded by HDF5, no modifications will need to be made to an existing HDF5 application. For more information on using the DAOS VOL connector as a dynamically-loaded plugin, refer to Appendix~\ref{apdx:hdf5_dyn_vol_connectors}.

\subsubsection{Without the DAOS VOL connector as a dynamically-loaded plugin}

If dynamic loading of the DAOS VOL connector is not used, any HDF5 application using the connector must:

\begin{enumerate}
    \item Include \texttt{daos\_vol\_public.h}, found in the \texttt{include} directory of the DAOS VOL connector installation directory.
    \item Link against \texttt{libhdf5\_vol\_daos.so} (or similar), found in the \texttt{lib} directory of the DAOS VOL connector installation directory, and against \texttt{libuuid.so} (or similar) in order to use UUIDs.
\end{enumerate}

An HDF5 DAOS VOL connector application also requires three new function calls in addition to those for an equivalent HDF5 application (see Appendix~\ref{apdx:ref_manual} for more details):

\begin{itemize}
    \item \texttt{\hyperref[ref:h5daos_init]{H5daos\_init()}} - Initializes the DAOS VOL connector

    Called upon application startup, before any file is accessed.

    \item \texttt{\hyperref[ref:h5pset_fapl_daos]{H5Pset\_fapl\_daos()}} - Set DAOS VOL connector access on File Access Property List.

    Called to prepare a FAPL to open a file through the DAOS VOL connector. See \href{https://support.hdfgroup.org/HDF5/Tutor/property.html#fa}{HDF5 File Access Property Lists} for more information about File Access Property Lists.

    \item \texttt{\hyperref[ref:h5daos_term]{H5daos\_term()}} - Cleanly shutdown the DAOS VOL connector

    Called on application shutdown, after all files have been closed.
\end{itemize}

\newpage

\subsubsection{Skeleton Example}

Below is a no-op application that opens and closes a file using the DAOS VOL connector. For clarity, no error-checking is performed. Note that this example is meant only for the case when the DAOS VOL connector is not being dynamically loaded.

\begin{verbatim}
#include "hdf5.h"
#include "daos_vol_public.h"

int main(void)
{
    uuid_t pool_uuid;
    hid_t fapl_id;
    hid_t file_id;

    /* Parse the pool UUID. */
    uuid_parse("fce30f79-b34b-46c1-9b1f-bb52d99dacca", pool_uuid);

    /* 
     * Initialize DAOS VOL connector using MPI_COMM_WORLD for the pool
     * communicator, the above parsed UUID for the pool UUID, "daos_server"
     * as the process set name for the DAOS servers managing the pool and
     * simply rank 0 as the only pool service replica rank.
     */
    H5daos_init(MPI_COMM_WORLD, pool_uuid, "daos_server", "0");

    fapl_id = H5Pcreate(H5P_FILE_ACCESS);
    H5Pset_fapl_daos(fapl_id, MPI_COMM_WORLD, MPI_INFO_NULL);

    /* Currently required for the DAOS VOL connector */
    H5Pset_all_coll_metadata_ops(fapl_id, true); 

    file_id = H5Fopen("my_file.h5", H5F_ACC_RDWR, fapl_id);

    /* operate on file */

    H5Pclose(fapl_id);
    H5Fclose(file_id);

    /* Terminate the DAOS VOL connector. */
    H5daos_term();

    return 0;
}
\end{verbatim}

\newpage

\subsection{Building HDF5 DAOS VOL connector applications}

Assuming an HDF5 application has been written following the instructions in the previous section, the application must be built prior to running. In general, the application should be built as normal for any other HDF5 application. However, if the DAOS VOL connector is not being dynamically loaded, the steps in the following section are required to build the application.

\subsubsection{Without the DAOS VOL connector as a dynamically-loaded plugin}

To link in the required libraries, the compiler will likely require the additional linker flags:

\begin{verbatim}
-lhdf5_vol_daos -luuid
\end{verbatim}

However, these flags may vary depending on platform, compiler and installation location of the DAOS VOL connector. It is highly recommended that compilation of HDF5 DAOS VOL connector applications be done using the \texttt{h5cc/h5pcc} script included with HDF5 distributions, as it will manage linking with the HDF5 library. If HDF5 was built using Autotools, this script will be called \texttt{h5pcc} and may be found in the \texttt{bin} directory of the HDF5 installation. If HDF5 was built with CMake, this script will simply be called \texttt{h5cc} and can be found in the same location. The above notice about additional library linking applies to usage of \texttt{h5cc/h5pcc}. For example:

\begin{verbatim}
h5cc/h5pcc -lhdf5_vol_daos -luuid my_daosvol_application.c -o my_executable
\end{verbatim}

\newpage

\subsection{Running HDF5 DAOS VOL connector applications}
\label{running_daos_vol_apps}

Running applications that use the HDF5 DAOS VOL connector requires access to a server which implements the \href{https://github.com/daos-stack/daos/blob/master/src/include/daos_api.h}{DAOS API}. Refer to \href{https://daos-stack.github.io/admin/installation/}{DAOS Software Installation} for more information on the setup process for this. For the DAOS VOL connector to correctly interact with a DAOS API-aware server instance, the server must be \hyperref[sec:daos_serv_start]{running} and it must be passed the UUID of the DAOS Pool to use and a list of DAOS Pool service replica ranks, as detailed in the following sections.

\subsubsection{Starting the DAOS Server}
\label{sec:daos_serv_start}

Instructions for starting a DAOS Server can be found in the \href{https://daos-stack.github.io/admin/deployment/#server-startup}{DAOS Documentation}.

\subsubsection{With the DAOS VOL connector as a dynamically-loaded plugin}

If the DAOS VOL connector is dynamically loaded by HDF5, the DAOS Pool UUID and DAOS Pool service replica rank list are passed via the two environment variables below. For more information on using the DAOS VOL connector as a dynamically-loaded plugin, refer to Appendix~\ref{apdx:hdf5_dyn_vol_connectors}.

\begin{verbatim}
DAOS_POOL - The UUID of the DAOS pool to use

DAOS_SVCL - A comma-separated list of MPI ranks used for daos_pool_connect().
            Currently, for simple 1 MPI rank operations this should simply be
            specified as DAOS_SVCL=0
\end{verbatim}

\subsubsection{Without the DAOS VOL connector as a dynamically-loaded plugin}

If the DAOS VOL connector is not being dynamically loaded, the DAOS Pool UUID and DAOS Pool service replica rank list should be passed via the call to \hyperref[ref:h5daos_init]{H5daos\_init()} within the application.

\subsubsection{Example Applications}

Some of the example C applications which are included with HDF5 distributions have been adapted to work with the HDF5 DAOS VOL connector and are included under the top-level \href{https://bitbucket.hdfgroup.org/projects/HDF5VOL/repos/daos-vol/browse/examples}{\texttt{examples}} directory in the DAOS VOL connector source root directory. The built example applications can be run from the \texttt{bin} directory inside the build directory.

In addition to these examples, the \href{https://bitbucket.hdfgroup.org/projects/HDF5VOL/repos/daos-vol/browse/test}{\texttt{test/vol}} directory contains several test files, each containing test functions that are examples of HDF5 applications in miniature, focused on a particular behavior. These mini-application tests cover a moderate amount of HDF5's public API functionality and should be a good indicator of whether the DAOS VOL connector is working correctly in conjunction with a running DAOS API-aware instance. Note that these tests currently rely on HDF5's dynamically-loaded VOL connector capabilities (Appendix~\ref{apdx:hdf5_dyn_vol_connectors}) in order to run with the DAOS VOL connector.